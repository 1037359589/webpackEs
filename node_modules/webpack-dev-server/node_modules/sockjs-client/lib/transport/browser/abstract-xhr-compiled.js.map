{"version":3,"sources":["abstract-xhr.js"],"names":[],"mappings":"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","file":"abstract-xhr-compiled.js","sourcesContent":["'use strict';\n\nvar EventEmitter = require('events').EventEmitter\n  , inherits = require('inherits')\n  , utils = require('../../utils/event')\n  , urlUtils = require('../../utils/url')\n  , XHR = global.XMLHttpRequest\n  ;\n\nvar debug = function() {};\nif (process.env.NODE_ENV !== 'production') {\n  debug = require('debug')('sockjs-client:browser:xhr');\n}\n\nfunction AbstractXHRObject(method, url, payload, opts) {\n  debug(method, url);\n  var self = this;\n  EventEmitter.call(this);\n\n  setTimeout(function () {\n    self._start(method, url, payload, opts);\n  }, 0);\n}\n\ninherits(AbstractXHRObject, EventEmitter);\n\nAbstractXHRObject.prototype._start = function(method, url, payload, opts) {\n  var self = this;\n\n  try {\n    this.xhr = new XHR();\n  } catch (x) {}\n\n  if (!this.xhr) {\n    debug('no xhr');\n    this.emit('finish', 0, 'no xhr support');\n    this._cleanup();\n    return;\n  }\n\n  // several browsers cache POSTs\n  url = urlUtils.addQuery(url, 't=' + (+new Date()));\n\n  // Explorer tends to keep connection open, even after the\n  // tab gets closed: http://bugs.jquery.com/ticket/5280\n  this.unloadRef = utils.unloadAdd(function() {\n    debug('unload cleanup');\n    self._cleanup(true);\n  });\n  try {\n    this.xhr.open(method, url, true);\n    if (this.timeout && 'timeout' in this.xhr) {\n      this.xhr.timeout = this.timeout;\n      this.xhr.ontimeout = function() {\n        debug('xhr timeout');\n        self.emit('finish', 0, '');\n        self._cleanup(false);\n      };\n    }\n  } catch (e) {\n    debug('exception', e);\n    // IE raises an exception on wrong port.\n    this.emit('finish', 0, '');\n    this._cleanup(false);\n    return;\n  }\n\n  if ((!opts || !opts.noCredentials) && AbstractXHRObject.supportsCORS) {\n    debug('withCredentials');\n    // Mozilla docs says https://developer.mozilla.org/en/XMLHttpRequest :\n    // \"This never affects same-site requests.\"\n\n    this.xhr.withCredentials = 'true';\n  }\n  if (opts && opts.headers) {\n    for (var key in opts.headers) {\n      this.xhr.setRequestHeader(key, opts.headers[key]);\n    }\n  }\n\n  this.xhr.onreadystatechange = function() {\n    if (self.xhr) {\n      var x = self.xhr;\n      var text, status;\n      debug('readyState', x.readyState);\n      switch (x.readyState) {\n      case 3:\n        // IE doesn't like peeking into responseText or status\n        // on Microsoft.XMLHTTP and readystate=3\n        try {\n          status = x.status;\n          text = x.responseText;\n        } catch (e) {}\n        debug('status', status);\n        // IE returns 1223 for 204: http://bugs.jquery.com/ticket/1450\n        if (status === 1223) {\n          status = 204;\n        }\n\n        // IE does return readystate == 3 for 404 answers.\n        if (status === 200 && text && text.length > 0) {\n          debug('chunk');\n          self.emit('chunk', status, text);\n        }\n        break;\n      case 4:\n        status = x.status;\n        debug('status', status);\n        // IE returns 1223 for 204: http://bugs.jquery.com/ticket/1450\n        if (status === 1223) {\n          status = 204;\n        }\n        // IE returns this for a bad port\n        // http://msdn.microsoft.com/en-us/library/windows/desktop/aa383770(v=vs.85).aspx\n        if (status === 12005 || status === 12029) {\n          status = 0;\n        }\n\n        debug('finish', status, x.responseText);\n        self.emit('finish', status, x.responseText);\n        self._cleanup(false);\n        break;\n      }\n    }\n  };\n\n  try {\n    self.xhr.send(payload);\n  } catch (e) {\n    self.emit('finish', 0, '');\n    self._cleanup(false);\n  }\n};\n\nAbstractXHRObject.prototype._cleanup = function(abort) {\n  debug('cleanup');\n  if (!this.xhr) {\n    return;\n  }\n  this.removeAllListeners();\n  utils.unloadDel(this.unloadRef);\n\n  // IE needs this field to be a function\n  this.xhr.onreadystatechange = function() {};\n  if (this.xhr.ontimeout) {\n    this.xhr.ontimeout = null;\n  }\n\n  if (abort) {\n    try {\n      this.xhr.abort();\n    } catch (x) {}\n  }\n  this.unloadRef = this.xhr = null;\n};\n\nAbstractXHRObject.prototype.close = function() {\n  debug('close');\n  this._cleanup(true);\n};\n\nAbstractXHRObject.enabled = !!XHR;\n// override XMLHttpRequest for IE6/7\n// obfuscate to avoid firewalls\nvar axo = ['Active'].concat('Object').join('X');\nif (!AbstractXHRObject.enabled && (axo in global)) {\n  debug('overriding xmlhttprequest');\n  XHR = function() {\n    try {\n      return new global[axo]('Microsoft.XMLHTTP');\n    } catch (e) {\n      return null;\n    }\n  };\n  AbstractXHRObject.enabled = !!new XHR();\n}\n\nvar cors = false;\ntry {\n  cors = 'withCredentials' in new XHR();\n} catch (ignored) {}\n\nAbstractXHRObject.supportsCORS = cors;\n\nmodule.exports = AbstractXHRObject;\n"]}