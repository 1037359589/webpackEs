{"version":3,"sources":["buffered-sender.js"],"names":[],"mappings":"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","file":"buffered-sender-compiled.js","sourcesContent":["'use strict';\n\nvar inherits = require('inherits')\n  , EventEmitter = require('events').EventEmitter\n  ;\n\nvar debug = function() {};\nif (process.env.NODE_ENV !== 'production') {\n  debug = require('debug')('sockjs-client:buffered-sender');\n}\n\nfunction BufferedSender(url, sender) {\n  debug(url);\n  EventEmitter.call(this);\n  this.sendBuffer = [];\n  this.sender = sender;\n  this.url = url;\n}\n\ninherits(BufferedSender, EventEmitter);\n\nBufferedSender.prototype.send = function(message) {\n  debug('send', message);\n  this.sendBuffer.push(message);\n  if (!this.sendStop) {\n    this.sendSchedule();\n  }\n};\n\n// For polling transports in a situation when in the message callback,\n// new message is being send. If the sending connection was started\n// before receiving one, it is possible to saturate the network and\n// timeout due to the lack of receiving socket. To avoid that we delay\n// sending messages by some small time, in order to let receiving\n// connection be started beforehand. This is only a halfmeasure and\n// does not fix the big problem, but it does make the tests go more\n// stable on slow networks.\nBufferedSender.prototype.sendScheduleWait = function() {\n  debug('sendScheduleWait');\n  var self = this;\n  var tref;\n  this.sendStop = function() {\n    debug('sendStop');\n    self.sendStop = null;\n    clearTimeout(tref);\n  };\n  tref = setTimeout(function() {\n    debug('timeout');\n    self.sendStop = null;\n    self.sendSchedule();\n  }, 25);\n};\n\nBufferedSender.prototype.sendSchedule = function() {\n  debug('sendSchedule', this.sendBuffer.length);\n  var self = this;\n  if (this.sendBuffer.length > 0) {\n    var payload = '[' + this.sendBuffer.join(',') + ']';\n    this.sendStop = this.sender(this.url, payload, function(err) {\n      self.sendStop = null;\n      if (err) {\n        debug('error', err);\n        self.emit('close', err.code || 1006, 'Sending error: ' + err);\n        self._cleanup();\n      } else {\n        self.sendScheduleWait();\n      }\n    });\n    this.sendBuffer = [];\n  }\n};\n\nBufferedSender.prototype._cleanup = function() {\n  debug('_cleanup');\n  this.removeAllListeners();\n};\n\nBufferedSender.prototype.stop = function() {\n  debug('stop');\n  this._cleanup();\n  if (this.sendStop) {\n    this.sendStop();\n    this.sendStop = null;\n  }\n};\n\nmodule.exports = BufferedSender;\n"]}