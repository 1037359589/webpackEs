{"version":3,"sources":["base.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AAEb,IAAI,OAAO,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,YAAY;IACxC,IAAI,GAAM,OAAO,CAAC,MAAM,CAAC;IACzB,OAAO,GAAG,OAAO,CAAC,YAAY,CAAC;IAC/B,OAAO,GAAG,OAAO,CAAC,WAAW,CAAC;IAC9B,MAAM,GAAI,OAAO,CAAC,iBAAiB,CAAC,CAAC;;AAEzC,IAAI,IAAI,GAAG,UAAS,OAAO,EAAE,GAAG,EAAE,OAAO,EAAE;AACzC,SAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACnB,MAAI,CAAC,eAAe,CAAC,OAAO,IAAI,EAAE,EAAE,CAAC,WAAW,EAAE,SAAS,EAAE,gBAAgB,EAAE,WAAW,CAAC,CAAC,CAAC;;AAE7F,MAAI,CAAC,QAAQ,GAAK,OAAO,CAAC;AAC1B,MAAI,CAAC,OAAO,GAAM,IAAI,MAAM,EAAE,CAAC;AAC/B,MAAI,CAAC,QAAQ,GAAK,OAAO,IAAI,EAAE,CAAC;AAChC,MAAI,CAAC,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,IAAI,IAAI,CAAC,UAAU,CAAC;AAC7D,MAAI,CAAC,QAAQ,GAAK,IAAI,OAAO,EAAE,CAAC;AAChC,MAAI,CAAC,OAAO,GAAM,EAAE,CAAC;AACrB,MAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AACpB,MAAI,CAAC,GAAG,GAAU,GAAG,CAAC;;AAEtB,MAAI,CAAC,EAAE,GAAG,IAAI,OAAO,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC;AAC/B,MAAI,CAAC,QAAQ,GAAG,IAAI,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;AAC3C,MAAI,CAAC,mBAAmB,EAAE,CAAC;CAC5B,CAAC;AACF,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;;AAE7B,IAAI,CAAC,eAAe,GAAG,UAAS,OAAO,EAAE,SAAS,EAAE;AAClD,OAAK,IAAI,GAAG,IAAI,OAAO,EAAE;AACvB,QAAI,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,EAC5B,MAAM,IAAI,KAAK,CAAC,uBAAuB,GAAG,GAAG,CAAC,CAAC;GAClD;CACF,CAAC;;AAEF,IAAI,QAAQ,GAAG;;;AAGb,YAAU,EAAE,SAAS;;AAErB,QAAM,EAAE,CAAC,YAAY,EAAE,MAAM,EAAE,SAAS,EAAE,QAAQ,CAAC;;AAEnD,qBAAmB,EAAE,YAAW;AAC9B,QAAI,IAAI,GAAG,IAAI;;;AAAC,AAGhB,QAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,OAAO,EAAE,YAAW,EAAE,CAAC,CAAC;;AAEzC,QAAI,CAAC,EAAE,CAAC,SAAS,EAAE,UAAS,KAAK,EAAE;AACjC,UAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;AAC7B,UAAI,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC;KAC1D,CAAC,CAAC;;AAEH,QAAI,CAAC,EAAE,CAAC,OAAO,EAAE,UAAS,KAAK,EAAE;AAC/B,UAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;AAC7B,UAAI,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;KACtD,CAAC,CAAC;;AAEH,QAAI,CAAC,EAAE,CAAC,OAAO,EAAE,YAAW;AAC1B,UAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;AAC7B,UAAI,CAAC,QAAQ,CAAC,QAAQ,EAAE,OAAO;AAC/B,cAAQ,CAAC,QAAQ,GAAG,QAAQ,CAAC,QAAQ,GAAG,KAAK,CAAC;AAC9C,cAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;KACtB,CAAC,CAAC;GACJ;;AAED,UAAQ,EAAE,YAAW;AACnB,WAAO,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,IAAI,CAAC;GAC7C;;AAED,cAAY,EAAE,UAAS,SAAS,EAAE;AAChC,WAAO,KAAK,CAAC;GACd;;AAED,WAAS,EAAE,UAAS,IAAI,EAAE,KAAK,EAAE;AAC/B,QAAI,IAAI,CAAC,UAAU,GAAG,CAAC,EAAE,OAAO,KAAK,CAAC;AACtC,QAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;AAC/B,WAAO,IAAI,CAAC;GACb;;AAED,OAAK,EAAE,YAAW;AAChB,QAAI,IAAI,CAAC,UAAU,KAAK,CAAC,EAAE,OAAO,KAAK,CAAC;AACxC,QAAI,QAAQ,GAAG,IAAI,CAAC,kBAAkB,EAAE,CAAC;AACzC,QAAI,CAAC,QAAQ,EAAE,OAAO,KAAK,CAAC;AAC5B,QAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;AACtB,QAAI,IAAI,CAAC,MAAM,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC;AACrC,WAAO,IAAI,CAAC;GACb;;AAED,MAAI,EAAE,UAAS,OAAO,EAAE;AACtB,WAAO,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;GAC5B;;AAED,QAAM,EAAE,UAAS,OAAO,EAAE;AACxB,WAAO,KAAK,CAAC;GACd;;AAED,MAAI,EAAE,YAAW;AACf,WAAO,KAAK,CAAC;GACd;;AAED,MAAI,EAAE,YAAW;AACb,WAAO,KAAK,CAAC;GAChB;;AAED,OAAK,EAAE,UAAS,MAAM,EAAE,IAAI,EAAE;AAC5B,QAAI,IAAI,CAAC,UAAU,KAAK,CAAC,EAAE,OAAO,KAAK,CAAC;AACxC,QAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AACpB,QAAI,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,IAAI,CAAC,UAAU,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;AACpD,WAAO,IAAI,CAAC;GACb;;AAED,OAAK,EAAE,YAAW;AAChB,QAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AACpB,QAAI,CAAC,OAAO,CAAC,OAAO,CAAC,UAAS,IAAI,EAAE;AAAE,UAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;KAAE,EAAE,IAAI,CAAC,CAAC;AAC5E,QAAI,CAAC,OAAO,GAAG,EAAE,CAAC;AAClB,QAAI,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC;GACzC;;AAED,QAAM,EAAE,UAAS,OAAO,EAAE;AACxB,QAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AAC3B,WAAO,IAAI,CAAC;GACb;;AAED,QAAM,EAAE,UAAS,KAAK,EAAE;AACtB,QAAI,EAAE,GAAG,IAAI,CAAC,EAAE,CAAC;AACjB,QAAI,EAAE,CAAC,QAAQ,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;GACzC;CACF,CAAC;;AAEF,KAAK,IAAI,GAAG,IAAI,QAAQ,EACtB,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC;;AAGtC,IAAI,CAAC,YAAY,GAAG,YAAW,EAAE,CAAC;;AAElC,IAAI,CAAC,SAAS,GAAG,YAAW,EAAE,CAAC;;AAE/B,IAAI,CAAC,UAAU,GAAG,UAAS,IAAI,EAAE,MAAM,EAAE;AACvC,MAAI,CAAC,IAAI,GAAK,IAAI,CAAC;AACnB,MAAI,CAAC,MAAM,GAAG,MAAM,CAAC;CACtB,CAAC;;AAEF,IAAI,CAAC,YAAY,GAAG,UAAS,IAAI,EAAE;AACjC,MAAI,CAAC,IAAI,GAAG,IAAI,CAAC;CAClB,CAAC;;AAEF,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC","file":"base-compiled.js","sourcesContent":["'use strict';\n\nvar Emitter = require('events').EventEmitter,\n    util    = require('util'),\n    streams = require('../streams'),\n    Headers = require('./headers'),\n    Reader  = require('./stream_reader');\n\nvar Base = function(request, url, options) {\n  Emitter.call(this);\n  Base.validateOptions(options || {}, ['maxLength', 'masking', 'requireMasking', 'protocols']);\n\n  this._request   = request;\n  this._reader    = new Reader();\n  this._options   = options || {};\n  this._maxLength = this._options.maxLength || this.MAX_LENGTH;\n  this._headers   = new Headers();\n  this.__queue    = [];\n  this.readyState = 0;\n  this.url        = url;\n\n  this.io = new streams.IO(this);\n  this.messages = new streams.Messages(this);\n  this._bindEventListeners();\n};\nutil.inherits(Base, Emitter);\n\nBase.validateOptions = function(options, validKeys) {\n  for (var key in options) {\n    if (validKeys.indexOf(key) < 0)\n      throw new Error('Unrecognized option: ' + key);\n  }\n};\n\nvar instance = {\n  // This is 64MB, small enough for an average VPS to handle without\n  // crashing from process out of memory\n  MAX_LENGTH: 0x3ffffff,\n\n  STATES: ['connecting', 'open', 'closing', 'closed'],\n\n  _bindEventListeners: function() {\n    var self = this;\n\n    // Protocol errors are informational and do not have to be handled\n    this.messages.on('error', function() {});\n\n    this.on('message', function(event) {\n      var messages = self.messages;\n      if (messages.readable) messages.emit('data', event.data);\n    });\n\n    this.on('error', function(error) {\n      var messages = self.messages;\n      if (messages.readable) messages.emit('error', error);\n    });\n\n    this.on('close', function() {\n      var messages = self.messages;\n      if (!messages.readable) return;\n      messages.readable = messages.writable = false;\n      messages.emit('end');\n    });\n  },\n\n  getState: function() {\n    return this.STATES[this.readyState] || null;\n  },\n\n  addExtension: function(extension) {\n    return false;\n  },\n\n  setHeader: function(name, value) {\n    if (this.readyState > 0) return false;\n    this._headers.set(name, value);\n    return true;\n  },\n\n  start: function() {\n    if (this.readyState !== 0) return false;\n    var response = this._handshakeResponse();\n    if (!response) return false;\n    this._write(response);\n    if (this._stage !== -1) this._open();\n    return true;\n  },\n\n  text: function(message) {\n    return this.frame(message);\n  },\n\n  binary: function(message) {\n    return false;\n  },\n\n  ping: function() {\n    return false;\n  },\n\n  pong: function() {\n      return false;\n  },\n\n  close: function(reason, code) {\n    if (this.readyState !== 1) return false;\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n\n  _open: function() {\n    this.readyState = 1;\n    this.__queue.forEach(function(args) { this.frame.apply(this, args) }, this);\n    this.__queue = [];\n    this.emit('open', new Base.OpenEvent());\n  },\n\n  _queue: function(message) {\n    this.__queue.push(message);\n    return true;\n  },\n\n  _write: function(chunk) {\n    var io = this.io;\n    if (io.readable) io.emit('data', chunk);\n  }\n};\n\nfor (var key in instance)\n  Base.prototype[key] = instance[key];\n\n\nBase.ConnectEvent = function() {};\n\nBase.OpenEvent = function() {};\n\nBase.CloseEvent = function(code, reason) {\n  this.code   = code;\n  this.reason = reason;\n};\n\nBase.MessageEvent = function(data) {\n  this.data = data;\n};\n\nmodule.exports = Base;\n"]}