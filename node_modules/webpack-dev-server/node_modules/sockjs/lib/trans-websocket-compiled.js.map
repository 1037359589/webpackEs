{"version":3,"sources":["trans-websocket.js"],"names":[],"mappings":"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","file":"trans-websocket-compiled.js","sourcesContent":["// Generated by CoffeeScript 1.9.1\n(function() {\n  var FayeWebsocket, RawWebsocketSessionReceiver, Transport, WebSocketReceiver, transport, utils,\n    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n    hasProp = {}.hasOwnProperty;\n\n  FayeWebsocket = require('faye-websocket');\n\n  utils = require('./utils');\n\n  transport = require('./transport');\n\n  exports.app = {\n    _websocket_check: function(req, connection, head) {\n      if (!FayeWebsocket.isWebSocket(req)) {\n        throw {\n          status: 400,\n          message: 'Not a valid websocket request'\n        };\n      }\n    },\n    sockjs_websocket: function(req, connection, head) {\n      var ws;\n      this._websocket_check(req, connection, head);\n      ws = new FayeWebsocket(req, connection, head, null, this.options.faye_server_options);\n      ws.onopen = (function(_this) {\n        return function() {\n          return transport.registerNoSession(req, _this, new WebSocketReceiver(ws, connection));\n        };\n      })(this);\n      return true;\n    },\n    raw_websocket: function(req, connection, head) {\n      var ver, ws;\n      this._websocket_check(req, connection, head);\n      ver = req.headers['sec-websocket-version'] || '';\n      if (['8', '13'].indexOf(ver) === -1) {\n        throw {\n          status: 400,\n          message: 'Only supported WebSocket protocol is RFC 6455.'\n        };\n      }\n      ws = new FayeWebsocket(req, connection, head, null, this.options.faye_server_options);\n      ws.onopen = (function(_this) {\n        return function() {\n          return new RawWebsocketSessionReceiver(req, connection, _this, ws);\n        };\n      })(this);\n      return true;\n    }\n  };\n\n  WebSocketReceiver = (function(superClass) {\n    extend(WebSocketReceiver, superClass);\n\n    WebSocketReceiver.prototype.protocol = \"websocket\";\n\n    function WebSocketReceiver(ws1, connection1) {\n      var x;\n      this.ws = ws1;\n      this.connection = connection1;\n      try {\n        this.connection.setKeepAlive(true, 5000);\n        this.connection.setNoDelay(true);\n      } catch (_error) {\n        x = _error;\n      }\n      this.ws.addEventListener('message', (function(_this) {\n        return function(m) {\n          return _this.didMessage(m.data);\n        };\n      })(this));\n      WebSocketReceiver.__super__.constructor.call(this, this.connection);\n    }\n\n    WebSocketReceiver.prototype.setUp = function() {\n      WebSocketReceiver.__super__.setUp.apply(this, arguments);\n      return this.ws.addEventListener('close', this.thingy_end_cb);\n    };\n\n    WebSocketReceiver.prototype.tearDown = function() {\n      this.ws.removeEventListener('close', this.thingy_end_cb);\n      return WebSocketReceiver.__super__.tearDown.apply(this, arguments);\n    };\n\n    WebSocketReceiver.prototype.didMessage = function(payload) {\n      var i, len, message, msg, results, x;\n      if (this.ws && this.session && payload.length > 0) {\n        try {\n          message = JSON.parse(payload);\n        } catch (_error) {\n          x = _error;\n          return this.didClose(1002, 'Broken framing.');\n        }\n        if (payload[0] === '[') {\n          results = [];\n          for (i = 0, len = message.length; i < len; i++) {\n            msg = message[i];\n            results.push(this.session.didMessage(msg));\n          }\n          return results;\n        } else {\n          return this.session.didMessage(message);\n        }\n      }\n    };\n\n    WebSocketReceiver.prototype.doSendFrame = function(payload) {\n      var x;\n      if (this.ws) {\n        try {\n          this.ws.send(payload);\n          return true;\n        } catch (_error) {\n          x = _error;\n        }\n      }\n      return false;\n    };\n\n    WebSocketReceiver.prototype.didClose = function(status, reason) {\n      var x;\n      if (status == null) {\n        status = 1000;\n      }\n      if (reason == null) {\n        reason = \"Normal closure\";\n      }\n      WebSocketReceiver.__super__.didClose.apply(this, arguments);\n      try {\n        this.ws.close(status, reason, false);\n      } catch (_error) {\n        x = _error;\n      }\n      this.ws = null;\n      return this.connection = null;\n    };\n\n    return WebSocketReceiver;\n\n  })(transport.GenericReceiver);\n\n  Transport = transport.Transport;\n\n  RawWebsocketSessionReceiver = (function(superClass) {\n    extend(RawWebsocketSessionReceiver, superClass);\n\n    function RawWebsocketSessionReceiver(req, conn, server, ws1) {\n      this.ws = ws1;\n      this.prefix = server.options.prefix;\n      this.readyState = Transport.OPEN;\n      this.recv = {\n        connection: conn,\n        protocol: \"websocket-raw\"\n      };\n      this.connection = new transport.SockJSConnection(this);\n      this.decorateConnection(req);\n      server.emit('connection', this.connection);\n      this._end_cb = (function(_this) {\n        return function() {\n          return _this.didClose();\n        };\n      })(this);\n      this.ws.addEventListener('close', this._end_cb);\n      this._message_cb = (function(_this) {\n        return function(m) {\n          return _this.didMessage(m);\n        };\n      })(this);\n      this.ws.addEventListener('message', this._message_cb);\n    }\n\n    RawWebsocketSessionReceiver.prototype.didMessage = function(m) {\n      if (this.readyState === Transport.OPEN) {\n        this.connection.emit('data', m.data);\n      }\n    };\n\n    RawWebsocketSessionReceiver.prototype.send = function(payload) {\n      if (this.readyState !== Transport.OPEN) {\n        return false;\n      }\n      this.ws.send(payload);\n      return true;\n    };\n\n    RawWebsocketSessionReceiver.prototype.close = function(status, reason) {\n      if (status == null) {\n        status = 1000;\n      }\n      if (reason == null) {\n        reason = \"Normal closure\";\n      }\n      if (this.readyState !== Transport.OPEN) {\n        return false;\n      }\n      this.readyState = Transport.CLOSING;\n      this.ws.close(status, reason, false);\n      return true;\n    };\n\n    RawWebsocketSessionReceiver.prototype.didClose = function() {\n      var x;\n      if (!this.ws) {\n        return;\n      }\n      this.ws.removeEventListener('message', this._message_cb);\n      this.ws.removeEventListener('close', this._end_cb);\n      try {\n        this.ws.close(1000, \"Normal closure\", false);\n      } catch (_error) {\n        x = _error;\n      }\n      this.ws = null;\n      this.readyState = Transport.CLOSED;\n      this.connection.emit('end');\n      this.connection.emit('close');\n      return this.connection = null;\n    };\n\n    return RawWebsocketSessionReceiver;\n\n  })(transport.Session);\n\n}).call(this);\n"]}