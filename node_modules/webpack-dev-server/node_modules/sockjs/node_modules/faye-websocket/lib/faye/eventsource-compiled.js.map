{"version":3,"sources":["eventsource.js"],"names":[],"mappings":"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","file":"eventsource-compiled.js","sourcesContent":["var Stream      = require('stream').Stream,\n    util        = require('util'),\n    driver      = require('websocket-driver'),\n    Headers     = require('websocket-driver/lib/websocket/driver/headers'),\n    API         = require('./websocket/api'),\n    EventTarget = require('./websocket/api/event_target'),\n    Event       = require('./websocket/api/event');\n\nvar EventSource = function(request, response, options) {\n  this.writable = true;\n  options = options || {};\n\n  this._stream = response.socket;\n  this._ping   = options.ping  || this.DEFAULT_PING;\n  this._retry  = options.retry || this.DEFAULT_RETRY;\n\n  var scheme       = driver.isSecureRequest(request) ? 'https:' : 'http:';\n  this.url         = scheme + '//' + request.headers.host + request.url;\n  this.lastEventId = request.headers['last-event-id'] || '';\n  this.readyState  = API.CONNECTING;\n\n  var headers = new Headers(),\n      self    = this;\n\n  if (options.headers) {\n    for (var key in options.headers) headers.set(key, options.headers[key]);\n  }\n\n  if (!this._stream || !this._stream.writable) return;\n  process.nextTick(function() { self._open() });\n\n  this._stream.setTimeout(0);\n  this._stream.setNoDelay(true);\n\n  var handshake = 'HTTP/1.1 200 OK\\r\\n' +\n                  'Content-Type: text/event-stream\\r\\n' +\n                  'Cache-Control: no-cache, no-store\\r\\n' +\n                  'Connection: close\\r\\n' +\n                  headers.toString() +\n                  '\\r\\n' +\n                  'retry: ' + Math.floor(this._retry * 1000) + '\\r\\n\\r\\n';\n\n  this._write(handshake);\n\n  this._stream.on('drain', function() { self.emit('drain') });\n\n  if (this._ping)\n    this._pingTimer = setInterval(function() { self.ping() }, this._ping * 1000);\n\n  ['error', 'end'].forEach(function(event) {\n    self._stream.on(event, function() { self.close() });\n  });\n};\nutil.inherits(EventSource, Stream);\n\nEventSource.isEventSource = function(request) {\n  if (request.method !== 'GET') return false;\n  var accept = (request.headers.accept || '').split(/\\s*,\\s*/);\n  return accept.indexOf('text/event-stream') >= 0;\n};\n\nvar instance = {\n  DEFAULT_PING:   10,\n  DEFAULT_RETRY:  5,\n\n  _write: function(chunk) {\n    if (!this.writable) return false;\n    try {\n      return this._stream.write(chunk, 'utf8');\n    } catch (e) {\n      return false;\n    }\n  },\n\n  _open: function() {\n    if (this.readyState !== API.CONNECTING) return;\n\n    this.readyState = API.OPEN;\n\n    var event = new Event('open');\n    event.initEvent('open', false, false);\n    this.dispatchEvent(event);\n  },\n\n  write: function(message) {\n    return this.send(message);\n  },\n\n  end: function(message) {\n    if (message !== undefined) this.write(message);\n    this.close();\n  },\n\n  send: function(message, options) {\n    if (this.readyState > API.OPEN) return false;\n\n    message = String(message).replace(/(\\r\\n|\\r|\\n)/g, '$1data: ');\n    options = options || {};\n\n    var frame = '';\n    if (options.event) frame += 'event: ' + options.event + '\\r\\n';\n    if (options.id)    frame += 'id: '    + options.id    + '\\r\\n';\n    frame += 'data: ' + message + '\\r\\n\\r\\n';\n\n    return this._write(frame);\n  },\n\n  ping: function() {\n    return this._write(':\\r\\n\\r\\n');\n  },\n\n  close: function() {\n    if (this.readyState > API.OPEN) return false;\n\n    this.readyState = API.CLOSED;\n    this.writable = false;\n    if (this._pingTimer) clearInterval(this._pingTimer);\n    if (this._stream) this._stream.end();\n\n    var event = new Event('close');\n    event.initEvent('close', false, false);\n    this.dispatchEvent(event);\n\n    return true;\n  }\n};\n\nfor (var method in instance) EventSource.prototype[method] = instance[method];\nfor (var key in EventTarget) EventSource.prototype[key] = EventTarget[key];\n\nmodule.exports = EventSource;\n"]}