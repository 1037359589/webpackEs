{"version":3,"sources":["api.js"],"names":[],"mappings":"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","file":"api-compiled.js","sourcesContent":["var Stream      = require('stream').Stream,\n    util        = require('util'),\n    driver      = require('websocket-driver'),\n    EventTarget = require('./api/event_target'),\n    Event       = require('./api/event');\n\nvar API = function(options) {\n  options = options || {};\n  driver.validateOptions(options, ['headers', 'extensions', 'maxLength', 'ping', 'proxy', 'tls', 'ca']);\n\n  this.readable = this.writable = true;\n\n  var headers = options.headers;\n  if (headers) {\n    for (var name in headers) this._driver.setHeader(name, headers[name]);\n  }\n\n  var extensions = options.extensions;\n  if (extensions) {\n    [].concat(extensions).forEach(this._driver.addExtension, this._driver);\n  }\n\n  this._ping          = options.ping;\n  this._pingId        = 0;\n  this.readyState     = API.CONNECTING;\n  this.bufferedAmount = 0;\n  this.protocol       = '';\n  this.url            = this._driver.url;\n  this.version        = this._driver.version;\n\n  var self = this;\n\n  this._driver.on('open',    function(e) { self._open() });\n  this._driver.on('message', function(e) { self._receiveMessage(e.data) });\n  this._driver.on('close',   function(e) { self._beginClose(e.reason, e.code) });\n\n  this._driver.on('error', function(error) {\n    self._emitError(error.message);\n  });\n  this.on('error', function() {});\n\n  this._driver.messages.on('drain', function() {\n    self.emit('drain');\n  });\n\n  if (this._ping)\n    this._pingTimer = setInterval(function() {\n      self._pingId += 1;\n      self.ping(self._pingId.toString());\n    }, this._ping * 1000);\n\n  this._configureStream();\n\n  if (!this._proxy) {\n    this._stream.pipe(this._driver.io);\n    this._driver.io.pipe(this._stream);\n  }\n};\nutil.inherits(API, Stream);\n\nAPI.CONNECTING = 0;\nAPI.OPEN       = 1;\nAPI.CLOSING    = 2;\nAPI.CLOSED     = 3;\n\nvar instance = {\n  write: function(data) {\n    return this.send(data);\n  },\n\n  end: function(data) {\n    if (data !== undefined) this.send(data);\n    this.close();\n  },\n\n  pause: function() {\n    return this._driver.messages.pause();\n  },\n\n  resume: function() {\n    return this._driver.messages.resume();\n  },\n\n  send: function(data) {\n    if (this.readyState > API.OPEN) return false;\n    if (!(data instanceof Buffer)) data = String(data);\n    return this._driver.messages.write(data);\n  },\n\n  ping: function(message, callback) {\n    if (this.readyState > API.OPEN) return false;\n    return this._driver.ping(message, callback);\n  },\n\n  close: function() {\n    if (this.readyState !== API.CLOSED) this.readyState = API.CLOSING;\n    this._driver.close();\n  },\n\n  _configureStream: function() {\n    var self = this;\n\n    this._stream.setTimeout(0);\n    this._stream.setNoDelay(true);\n\n    ['close', 'end'].forEach(function(event) {\n      this._stream.on(event, function() { self._finalizeClose() });\n    }, this);\n\n    this._stream.on('error', function(error) {\n      self._emitError('Network error: ' + self.url + ': ' + error.message);\n      self._finalizeClose();\n    });\n  },\n\n _open: function() {\n    if (this.readyState !== API.CONNECTING) return;\n\n    this.readyState = API.OPEN;\n    this.protocol = this._driver.protocol || '';\n\n    var event = new Event('open');\n    event.initEvent('open', false, false);\n    this.dispatchEvent(event);\n  },\n\n  _receiveMessage: function(data) {\n    if (this.readyState > API.OPEN) return false;\n\n    if (this.readable) this.emit('data', data);\n\n    var event = new Event('message', {data: data});\n    event.initEvent('message', false, false);\n    this.dispatchEvent(event);\n  },\n\n  _emitError: function(message) {\n    if (this.readyState >= API.CLOSING) return;\n\n    var event = new Event('error', {message: message});\n    event.initEvent('error', false, false);\n    this.dispatchEvent(event);\n  },\n\n  _beginClose: function(reason, code) {\n    if (this.readyState === API.CLOSED) return;\n    this.readyState = API.CLOSING;\n\n    if (this._stream) {\n      this._stream.end();\n      if (!this._stream.readable) this._finalizeClose();\n    }\n    this._closeParams = [reason, code];\n  },\n\n  _finalizeClose: function() {\n    if (this.readyState === API.CLOSED) return;\n    this.readyState = API.CLOSED;\n\n    if (this._pingTimer) clearInterval(this._pingTimer);\n    if (this._stream) this._stream.end();\n\n    if (this.readable) this.emit('end');\n    this.readable = this.writable = false;\n\n    var reason = this._closeParams ? this._closeParams[0] : '',\n        code   = this._closeParams ? this._closeParams[1] : 1006;\n\n    var event = new Event('close', {code: code, reason: reason});\n    event.initEvent('close', false, false);\n    this.dispatchEvent(event);\n  }\n};\n\nfor (var method in instance) API.prototype[method] = instance[method];\nfor (var key in EventTarget) API.prototype[key] = EventTarget[key];\n\nmodule.exports = API;\n"]}