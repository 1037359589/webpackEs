{"version":3,"sources":["draft75.js"],"names":[],"mappings":"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","file":"draft75-compiled.js","sourcesContent":["'use strict';\n\nvar Base = require('./base'),\n    util = require('util');\n\nvar Draft75 = function(request, url, options) {\n  Base.apply(this, arguments);\n  this._stage  = 0;\n  this.version = 'hixie-75';\n\n  this._headers.set('Upgrade', 'WebSocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('WebSocket-Origin', this._request.headers.origin);\n  this._headers.set('WebSocket-Location', this.url);\n};\nutil.inherits(Draft75, Base);\n\nvar instance = {\n  close: function() {\n    if (this.readyState === 3) return false;\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n\n  parse: function(chunk) {\n    if (this.readyState > 1) return;\n\n    this._reader.put(chunk);\n\n    this._reader.eachByte(function(octet) {\n      var message;\n\n      switch (this._stage) {\n        case -1:\n          this._body.push(octet);\n          this._sendHandshakeBody();\n          break;\n\n        case 0:\n          this._parseLeadingByte(octet);\n          break;\n\n        case 1:\n          this._length = (octet & 0x7F) + 128 * this._length;\n\n          if (this._closing && this._length === 0) {\n            return this.close();\n          }\n          else if ((octet & 0x80) !== 0x80) {\n            if (this._length === 0) {\n              this._stage = 0;\n            }\n            else {\n              this._skipped = 0;\n              this._stage   = 2;\n            }\n          }\n          break;\n\n        case 2:\n          if (octet === 0xFF) {\n            this._stage = 0;\n            message = new Buffer(this._buffer).toString('utf8', 0, this._buffer.length);\n            this.emit('message', new Base.MessageEvent(message));\n          }\n          else {\n            if (this._length) {\n              this._skipped += 1;\n              if (this._skipped === this._length)\n                this._stage = 0;\n            } else {\n              this._buffer.push(octet);\n              if (this._buffer.length > this._maxLength) return this.close();\n            }\n          }\n          break;\n      }\n    }, this);\n  },\n\n  frame: function(buffer) {\n    if (this.readyState === 0) return this._queue([buffer]);\n    if (this.readyState > 1) return false;\n\n    if (typeof buffer !== 'string') buffer = buffer.toString();\n\n    var payload = new Buffer(buffer, 'utf8'),\n        frame   = new Buffer(payload.length + 2);\n\n    frame[0] = 0x00;\n    frame[payload.length + 1] = 0xFF;\n    payload.copy(frame, 1);\n\n    this._write(frame);\n    return true;\n  },\n\n  _handshakeResponse: function() {\n    var start   = 'HTTP/1.1 101 Web Socket Protocol Handshake',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _parseLeadingByte: function(octet) {\n    if ((octet & 0x80) === 0x80) {\n      this._length = 0;\n      this._stage  = 1;\n    } else {\n      delete this._length;\n      delete this._skipped;\n      this._buffer = [];\n      this._stage  = 2;\n    }\n  }\n};\n\nfor (var key in instance)\n  Draft75.prototype[key] = instance[key];\n\nmodule.exports = Draft75;\n"]}