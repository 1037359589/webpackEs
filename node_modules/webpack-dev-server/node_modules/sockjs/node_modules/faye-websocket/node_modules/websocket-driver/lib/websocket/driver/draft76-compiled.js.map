{"version":3,"sources":["draft76.js"],"names":[],"mappings":"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","file":"draft76-compiled.js","sourcesContent":["'use strict';\n\nvar Base    = require('./base'),\n    Draft75 = require('./draft75'),\n    crypto  = require('crypto'),\n    util    = require('util');\n\n\nvar numberFromKey = function(key) {\n  return parseInt(key.match(/[0-9]/g).join(''), 10);\n};\n\nvar spacesInKey = function(key) {\n  return key.match(/ /g).length;\n};\n\n\nvar Draft76 = function(request, url, options) {\n  Draft75.apply(this, arguments);\n  this._stage  = -1;\n  this._body   = [];\n  this.version = 'hixie-76';\n\n  this._headers.clear();\n\n  this._headers.set('Upgrade', 'WebSocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('Sec-WebSocket-Origin', this._request.headers.origin);\n  this._headers.set('Sec-WebSocket-Location', this.url);\n};\nutil.inherits(Draft76, Draft75);\n\nvar instance = {\n  BODY_SIZE: 8,\n\n  start: function() {\n    if (!Draft75.prototype.start.call(this)) return false;\n    this._started = true;\n    this._sendHandshakeBody();\n    return true;\n  },\n\n  close: function() {\n    if (this.readyState === 3) return false;\n    this._write(new Buffer([0xFF, 0x00]));\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n\n  _handshakeResponse: function() {\n    var headers = this._request.headers,\n\n        key1    = headers['sec-websocket-key1'],\n        number1 = numberFromKey(key1),\n        spaces1 = spacesInKey(key1),\n\n        key2    = headers['sec-websocket-key2'],\n        number2 = numberFromKey(key2),\n        spaces2 = spacesInKey(key2);\n\n    if (number1 % spaces1 !== 0 || number2 % spaces2 !== 0) {\n      this.emit('error', new Error('Client sent invalid Sec-WebSocket-Key headers'));\n      this.close();\n      return null;\n    }\n\n    this._keyValues = [number1 / spaces1, number2 / spaces2];\n\n    var start   = 'HTTP/1.1 101 WebSocket Protocol Handshake',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'binary');\n  },\n\n  _handshakeSignature: function() {\n    if (this._body.length < this.BODY_SIZE) return null;\n\n    var md5    = crypto.createHash('md5'),\n        buffer = new Buffer(8 + this.BODY_SIZE);\n\n    buffer.writeUInt32BE(this._keyValues[0], 0);\n    buffer.writeUInt32BE(this._keyValues[1], 4);\n    new Buffer(this._body).copy(buffer, 8, 0, this.BODY_SIZE);\n\n    md5.update(buffer);\n    return new Buffer(md5.digest('binary'), 'binary');\n  },\n\n  _sendHandshakeBody: function() {\n    if (!this._started) return;\n    var signature = this._handshakeSignature();\n    if (!signature) return;\n\n    this._write(signature);\n    this._stage = 0;\n    this._open();\n\n    if (this._body.length > this.BODY_SIZE)\n      this.parse(this._body.slice(this.BODY_SIZE));\n  },\n\n  _parseLeadingByte: function(octet) {\n    if (octet !== 0xFF)\n      return Draft75.prototype._parseLeadingByte.call(this, octet);\n\n    this._closing = true;\n    this._length  = 0;\n    this._stage   = 1;\n  }\n};\n\nfor (var key in instance)\n  Draft76.prototype[key] = instance[key];\n\nmodule.exports = Draft76;\n"]}