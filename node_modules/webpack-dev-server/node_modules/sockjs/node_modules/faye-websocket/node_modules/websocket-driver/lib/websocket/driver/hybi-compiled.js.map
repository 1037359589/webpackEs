{"version":3,"sources":["hybi.js"],"names":[],"mappings":"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","file":"hybi-compiled.js","sourcesContent":["'use strict';\n\nvar crypto     = require('crypto'),\n    util       = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base       = require('./base'),\n    Frame      = require('./hybi/frame'),\n    Message    = require('./hybi/message');\n\nvar Hybi = function(request, url, options) {\n  Base.apply(this, arguments);\n\n  this._extensions     = new Extensions();\n  this._stage          = 0;\n  this._masking        = this._options.masking;\n  this._protocols      = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks  = {};\n\n  if (typeof this._protocols === 'string')\n    this._protocols = this._protocols.split(/ *, */);\n\n  if (!this._request) return;\n\n  var secKey    = this._request.headers['sec-websocket-key'],\n      protos    = this._request.headers['sec-websocket-protocol'],\n      version   = this._request.headers['sec-websocket-version'],\n      supported = this._protocols;\n\n  this._headers.set('Upgrade', 'websocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function(p) { return supported.indexOf(p) >= 0 })[0];\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n  }\n\n  this.version = 'hybi-' + version;\n};\nutil.inherits(Hybi, Base);\n\nHybi.mask = function(payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n  return payload;\n};\n\nHybi.generateAccept = function(key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n\nvar instance = {\n  FIN:    0x80,\n  MASK:   0x80,\n  RSV1:   0x40,\n  RSV2:   0x20,\n  RSV3:   0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n\n  OPCODES: {\n    continuation: 0,\n    text:         1,\n    binary:       2,\n    close:        8,\n    ping:         9,\n    pong:         10\n  },\n\n  OPCODE_CODES:    [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n\n  ERRORS: {\n    normal_closure:       1000,\n    going_away:           1001,\n    protocol_error:       1002,\n    unacceptable:         1003,\n    encoding_error:       1007,\n    policy_violation:     1008,\n    too_large:            1009,\n    extension_error:      1010,\n    unexpected_condition: 1011\n  },\n\n  ERROR_CODES:        [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n\n  addExtension: function(extension) {\n    this._extensions.add(extension);\n    return true;\n  },\n\n  parse: function(chunk) {\n    this._reader.put(chunk);\n    var buffer = true;\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n          if (buffer) {\n            this._stage = 0;\n            this._emitFrame(buffer);\n          }\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n\n  text: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n\n  binary: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n\n  ping: function(message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n\n  pong: function(message) {\n      if (this.readyState > 1) return false;\n      message = message ||'';\n      return this.frame(message, 'pong');\n  },\n\n  close: function(reason, code) {\n    reason = reason || '';\n    code   = code   || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n      this._extensions.close(function() { this.frame(reason, 'close', code) }, this);\n      return true;\n    } else {\n      return false;\n    }\n  },\n\n  frame: function(buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n\n    if (buffer instanceof Array)    buffer = new Buffer(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n\n    var message = new Message(),\n        isText  = (typeof buffer === 'string'),\n        payload, copy;\n\n    message.rsv1   = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n\n    payload = isText ? new Buffer(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = new Buffer(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n    message.data = payload;\n\n    var onMessageReady = function(message) {\n      var frame = new Frame();\n\n      frame.final   = true;\n      frame.rsv1    = message.rsv1;\n      frame.rsv2    = message.rsv2;\n      frame.rsv3    = message.rsv3;\n      frame.opcode  = message.opcode;\n      frame.masked  = !!this._masking;\n      frame.length  = message.data.length;\n      frame.payload = message.data;\n\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0)\n      this._extensions.processOutgoingMessage(message, function(error, message) {\n        if (error) return this._fail('extension_error', error.message);\n        onMessageReady.call(this, message);\n      }, this);\n    else\n      onMessageReady.call(this, message);\n\n    return true;\n  },\n\n  _sendFrame: function(frame) {\n    var length = frame.length,\n        header = (length <= 125) ? 2 : (length <= 65535 ? 4 : 10),\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = new Buffer(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n\n    buffer[0] = (frame.final ? this.FIN : 0) |\n                (frame.rsv1 ? this.RSV1 : 0) |\n                (frame.rsv2 ? this.RSV2 : 0) |\n                (frame.rsv3 ? this.RSV3 : 0) |\n                frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(frame.payload, frame.maskingKey).copy(buffer, offset);\n    } else {\n      frame.payload.copy(buffer, offset);\n    }\n\n    this._write(buffer);\n  },\n\n  _handshakeResponse: function() {\n    try {\n      var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n    } catch (e) {\n      return this._fail('protocol_error', e.message);\n    }\n\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n    var start   = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _shutdown: function(code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n\n    var sendCloseFrame = (this.readyState === 1);\n    this.readyState = 2;\n\n    this._extensions.close(function() {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n\n  _fail: function(type, message) {\n    if (this.readyState > 1) return;\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n\n  _parseOpcode: function(octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function(rsv) {\n      return (octet & rsv) === rsv;\n    });\n\n    var frame = this._frame = new Frame();\n\n    frame.final  = (octet & this.FIN) === this.FIN;\n    frame.rsv1   = rsvs[0];\n    frame.rsv2   = rsvs[1];\n    frame.rsv3   = rsvs[2];\n    frame.opcode = (octet & this.OPCODE);\n\n    this._stage = 1;\n\n    if (!this._extensions.validFrameRsv(frame))\n      return this._fail('protocol_error',\n          'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) +\n          ', reserved2 = ' + (frame.rsv2 ? 1 : 0) +\n          ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0)\n      return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final)\n      return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0)\n      return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n\n  _parseLength: function(octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = (octet & this.LENGTH);\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = (frame.length === 126 ? 2 : 8);\n    }\n\n    if (this._requireMasking && !frame.masked)\n      return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n\n  _parseExtendedLength: function(buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n\n    this._stage = frame.masked ? 3 : 4;\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125)\n      return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n\n    if (!this._checkFrameLength()) return;\n  },\n\n  _checkFrameLength: function() {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n      return false;\n    } else {\n      return true;\n    }\n  },\n\n  _emitFrame: function(buffer) {\n    var frame   = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode  = frame.opcode,\n        message,\n        code, reason,\n        callbacks, callback;\n\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0)\n      return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code   = (payload.length >= 2) ? payload.readUInt16BE(0) : null;\n      reason = (payload.length > 2) ? this._encode(payload.slice(2)) : null;\n\n      if (!(payload.length === 0) &&\n          !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) &&\n          this.ERROR_CODES.indexOf(code) < 0)\n        code = this.ERRORS.protocol_error;\n\n      if (payload.length > 125 || (payload.length > 2 && !reason))\n        code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message   = this._encode(payload);\n      callback  = callbacks[message];\n\n      delete callbacks[message];\n      if (callback) callback()\n    }\n  },\n\n  _emitMessage: function(message) {\n    var message = this._message;\n    message.read();\n\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function(error, message) {\n      if (error) return this._fail('extension_error', error.message);\n\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n\n      if (payload === null)\n        return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');\n      else\n        this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n\n  _encode: function(buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n\n  _readUInt: function(buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n\n    return buffer.readUInt32BE(0) * 0x100000000 +\n           buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance)\n  Hybi.prototype[key] = instance[key];\n\nmodule.exports = Hybi;\n"]}