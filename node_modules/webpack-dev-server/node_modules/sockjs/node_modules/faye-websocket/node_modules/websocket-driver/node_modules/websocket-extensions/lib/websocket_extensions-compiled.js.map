{"version":3,"sources":["websocket_extensions.js"],"names":[],"mappings":"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","file":"websocket_extensions-compiled.js","sourcesContent":["'use strict';\n\nvar Parser   = require('./parser'),\n    Pipeline = require('./pipeline');\n\nvar Extensions = function() {\n  this._rsv1 = this._rsv2 = this._rsv3 = null;\n\n  this._byName   = {};\n  this._inOrder  = [];\n  this._sessions = [];\n  this._index    = {}\n};\n\nExtensions.MESSAGE_OPCODES = [1, 2];\n\nvar instance = {\n  add: function(ext) {\n    if (typeof ext.name !== 'string') throw new TypeError('extension.name must be a string');\n    if (ext.type !== 'permessage') throw new TypeError('extension.type must be \"permessage\"');\n\n    if (typeof ext.rsv1 !== 'boolean') throw new TypeError('extension.rsv1 must be true or false');\n    if (typeof ext.rsv2 !== 'boolean') throw new TypeError('extension.rsv2 must be true or false');\n    if (typeof ext.rsv3 !== 'boolean') throw new TypeError('extension.rsv3 must be true or false');\n\n    if (this._byName.hasOwnProperty(ext.name))\n      throw new TypeError('An extension with name \"' + ext.name + '\" is already registered');\n\n    this._byName[ext.name] = ext;\n    this._inOrder.push(ext);\n  },\n\n  generateOffer: function() {\n    var sessions = [],\n        offer    = [],\n        index    = {};\n\n    this._inOrder.forEach(function(ext) {\n      var session = ext.createClientSession();\n      if (!session) return;\n\n      var record = [ext, session];\n      sessions.push(record);\n      index[ext.name] = record;\n\n      var offers = session.generateOffer();\n      offers = offers ? [].concat(offers) : [];\n\n      offers.forEach(function(off) {\n        offer.push(Parser.serializeParams(ext.name, off));\n      }, this);\n    }, this);\n\n    this._sessions = sessions;\n    this._index    = index;\n\n    return offer.length > 0 ? offer.join(', ') : null;\n  },\n\n  activate: function(header) {\n    var responses = Parser.parseHeader(header),\n        sessions  = [];\n\n    responses.eachOffer(function(name, params) {\n      var record = this._index[name];\n\n      if (!record)\n        throw new Error('Server sent an extension response for unknown extension \"' + name + '\"');\n\n      var ext      = record[0],\n          session  = record[1],\n          reserved = this._reserved(ext);\n\n      if (reserved)\n        throw new Error('Server sent two extension responses that use the RSV' +\n                        reserved[0] + ' bit: \"' +\n                        reserved[1] + '\" and \"' + ext.name + '\"');\n\n      if (session.activate(params) !== true)\n        throw new Error('Server sent unacceptable extension parameters: ' +\n                        Parser.serializeParams(name, params));\n\n      this._reserve(ext);\n      sessions.push(record);\n    }, this);\n\n    this._sessions = sessions;\n    this._pipeline = new Pipeline(sessions);\n  },\n\n  generateResponse: function(header) {\n    var offers   = Parser.parseHeader(header),\n        sessions = [],\n        response = [];\n\n    this._inOrder.forEach(function(ext) {\n      var offer = offers.byName(ext.name);\n      if (offer.length === 0 || this._reserved(ext)) return;\n\n      var session = ext.createServerSession(offer);\n      if (!session) return;\n\n      this._reserve(ext);\n      sessions.push([ext, session]);\n      response.push(Parser.serializeParams(ext.name, session.generateResponse()));\n    }, this);\n\n    this._sessions = sessions;\n    this._pipeline = new Pipeline(sessions);\n\n    return response.length > 0 ? response.join(', ') : null;\n  },\n\n  validFrameRsv: function(frame) {\n    var allowed = {rsv1: false, rsv2: false, rsv3: false},\n        ext;\n\n    if (Extensions.MESSAGE_OPCODES.indexOf(frame.opcode) >= 0) {\n      for (var i = 0, n = this._sessions.length; i < n; i++) {\n        ext = this._sessions[i][0];\n        allowed.rsv1 = allowed.rsv1 || ext.rsv1;\n        allowed.rsv2 = allowed.rsv2 || ext.rsv2;\n        allowed.rsv3 = allowed.rsv3 || ext.rsv3;\n      }\n    }\n\n    return (allowed.rsv1 || !frame.rsv1) &&\n           (allowed.rsv2 || !frame.rsv2) &&\n           (allowed.rsv3 || !frame.rsv3);\n  },\n\n  processIncomingMessage: function(message, callback, context) {\n    this._pipeline.processIncomingMessage(message, callback, context);\n  },\n\n  processOutgoingMessage: function(message, callback, context) {\n    this._pipeline.processOutgoingMessage(message, callback, context);\n  },\n\n  close: function(callback, context) {\n    if (!this._pipeline) return callback.call(context);\n    this._pipeline.close(callback, context);\n  },\n\n  _reserve: function(ext) {\n    this._rsv1 = this._rsv1 || (ext.rsv1 && ext.name);\n    this._rsv2 = this._rsv2 || (ext.rsv2 && ext.name);\n    this._rsv3 = this._rsv3 || (ext.rsv3 && ext.name);\n  },\n\n  _reserved: function(ext) {\n    if (this._rsv1 && ext.rsv1) return [1, this._rsv1];\n    if (this._rsv2 && ext.rsv2) return [2, this._rsv2];\n    if (this._rsv3 && ext.rsv3) return [3, this._rsv3];\n    return false;\n  }\n};\n\nfor (var key in instance)\n  Extensions.prototype[key] = instance[key];\n\nmodule.exports = Extensions;\n"]}